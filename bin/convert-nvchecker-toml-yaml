#!/bin/python
# SPDX-FileType: SOURCE
# SPDX-FileType: APPLICATION
# SPDX-FileCopyrightText: © 2024 Frederik “Freso” S. Olesen <https://freso.dk/>
# SPDX-License-Identifier: AGPL-3.0-or-later
"""Convert .nvchecker.toml files to YAML for use with aur-auto-update."""

import argparse
import sys
try:
    import tomllib as toml
except ImportError:
    import toml

from typing import Optional, IO

import yaml


def convert_toml_to_yaml(toml_raw: IO,
                         test: Optional[bool] = None,
                         oldver: Optional[str] = None) -> dict:
    """Generate YAML data from provided TOML input."""
    toml_parsed = toml.load(toml_raw)
    if len(toml_parsed.keys()) == 0:
        raise ValueError("Empty TOML file.")
    if len(toml_parsed.keys()) > 1:
        raise NotImplementedError("File contains multiple configurations which isn't handled yet.")
    yaml_dict = dict()
    for project in toml_parsed.keys():
        yaml_dict["nvchecker"] = toml_parsed.get(project)
        if test is not None:
            yaml_dict["test"] = test
        if oldver is not None:
            yaml_dict["oldver"] = oldver
    return yaml_dict


def parse_args(*argv: str) -> argparse.Namespace:
    """Parse command line arguments."""
    parser = argparse.ArgumentParser()
    parser.add_argument('--test',
                        default=None,
                        action=argparse.BooleanOptionalAction,
                        type=bool)
    parser.add_argument('--oldver',
                        default=None,
                        type=str)
    parser.add_argument("nvchecker_file",
                        help="the .nvchecker.toml file to convert",
                        metavar=".nvchecker.toml",
                        type=argparse.FileType('rb'))
    return parser.parse_args(argv)


def main(argv: Optional[list[str]] = None) -> int:
    """Read arguments from commandline and print out YAML data on stdout."""
    if argv is None:
        argv = sys.argv[1:]
    args = parse_args(*argv)
    yaml_data = convert_toml_to_yaml(args.nvchecker_file, test=args.test, oldver=args.oldver)
    print(yaml.dump(yaml_data))
    return 0


if __name__ == "__main__":
    sys.exit(main())
